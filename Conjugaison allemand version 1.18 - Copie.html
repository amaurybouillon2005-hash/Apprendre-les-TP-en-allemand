<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercice de Conjugaison Allemande</title>
    <!-- Chargement de la police Inter et de Tailwind CSS pour le style -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* D√©finition de la police Inter et des couleurs de base */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style des champs de saisie pour le feedback */
        input.correct {
            border-color: #10b981; /* vert pour correct */
        }
        input.incorrect {
            border-color: #ef4444; /* rouge pour incorrect */
        }
        /* Style de la bo√Æte de message flottante */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
            z-index: 1000;
            text-align: center;
        }
        .message-box.show {
            opacity: 1;
            pointer-events: auto;
        }
        /* Style de la modale de confirmation */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s;
        }
        .modal.show {
            visibility: visible;
            opacity: 1;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        /* Styles pour le champ de texte de copie */
        .copy-area-container {
            display: none; /* Initialement cach√© */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Conteneur principal de l'exercice -->
    <div class="w-full max-w-5xl p-6 bg-white rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">Exercice : Conjugaison Allemande</h1>
        <p class="text-center text-gray-600 mb-6">
            Ajoutez les verbes que vous souhaitez pratiquer. Ensuite, remplissez les cases pour v√©rifier vos connaissances. Vous pouvez maintenant aussi les supprimer.
        </p>

        <!-- Section pour ajouter de nouveaux verbes et g√©rer la liste -->
        <div id="setup-section" class="mb-8 p-6 bg-blue-50 rounded-lg border border-blue-200">
            <h2 class="text-xl font-bold text-gray-700 mb-4">Ajouter un verbe √† l'exercice</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
                <input type="text" id="input-french" placeholder="Traduction (Fran√ßais)" class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="input-infinitive" placeholder="Infinitif" class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="input-present" placeholder="Pr√©sent (er/sie/es)" class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="input-preterite" placeholder="Pr√©t√©rit" class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="input-pastParticiple" placeholder="Participe Pass√©" class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex justify-center flex-wrap gap-4">
                <button id="add-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300 transform hover:scale-105 shadow-md">
                    Ajouter le verbe
                </button>
                <button id="copy-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300 transform hover:scale-105 shadow-md">
                    Copier la liste
                </button>
                <button id="paste-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300 transform hover:scale-105 shadow-md">
                    Coller la liste
                </button>
                <!-- Bouton pour m√©langer les verbes (lignes) -->
                <button id="shuffle-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300 transform hover:scale-105 shadow-md">
                    M√©langer les verbes
                </button>
                <!-- Nouveau bouton pour basculer entre les modes -->
                <button id="mode-toggle-button" class="bg-gray-900 hover:bg-gray-800 text-white font-bold py-2 px-6 rounded-lg transition duration-300 transform hover:scale-105 shadow-md">
                    Mode Al√©atoire
                </button>
                 <!-- Nouveau bouton pour effacer la liste -->
                <button id="clear-button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 transform hover:scale-105 shadow-md">
                    Effacer la liste
                </button>
            </div>
            
            <!-- Zone pour la copie manuelle, initialement cach√©e -->
            <div id="copy-area-container" class="copy-area-container mt-4">
                <p class="text-sm text-gray-600 mb-2">
                    Copiez le texte ci-dessous et collez-le o√π vous le souhaitez pour le sauvegarder.
                </p>
                <textarea id="verb-list-output" rows="4" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
            
            <!-- Champ de saisie invisible pour le "coller" direct -->
            <input type="text" id="paste-target" style="position: absolute; left: -9999px;">
        </div>

        <!-- Tableau des verbes -->
        <div id="table-header" class="grid grid-cols-6 gap-4 text-center text-sm font-semibold text-gray-700 pb-2 border-b border-gray-200 hidden">
        </div>

        <!-- Compteur de blocs -->
        <div id="block-counter" class="text-center font-semibold text-gray-700 my-4 hidden"></div>

        <!-- Lignes de l'exercice -->
        <div id="exercice-container" class="space-y-4 pt-4">
            <p id="placeholder-text" class="text-center text-gray-500 text-lg italic">
                Commencez par ajouter un verbe ci-dessus.
            </p>
        </div>

        <!-- Boutons de navigation -->
        <div id="navigation-buttons" class="flex justify-center items-center mt-8 space-x-4 hidden">
            <button id="prev-button" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg transition duration-300 transform hover:scale-105 shadow-md hidden">
                &larr; Pr√©c√©dent
            </button>
            <button id="check-button" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 transform hover:scale-105 shadow-md hidden">
                V√©rifier les r√©ponses
            </button>
            <button id="next-button" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg transition duration-300 transform hover:scale-105 shadow-md hidden">
                Suivant &rarr;
            </button>
        </div>

        <!-- Message de r√©sultat -->
        <div id="result-message" class="mt-6 p-4 rounded-lg text-center font-semibold hidden"></div>
    </div>

    <!-- Bo√Æte de message flottante pour le feedback -->
    <div id="message-box" class="message-box"></div>

    <!-- Bo√Æte de dialogue de confirmation (rendue g√©n√©rique) -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <p id="modal-text" class="text-lg font-semibold mb-4">Voulez-vous vraiment continuer ?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-ok" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Oui</button>
                <button id="confirm-cancel" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Annuler</button>
            </div>
        </div>
    </div>

    <script>
        // Utilisation du mode strict pour √©viter les erreurs silencieuses
        "use strict";

        // Tableau pour stocker les verbes ajout√©s par l'utilisateur
        let verbsData = [];
        let confirmCallback = null;
        const verbsPerBlock = 5;
        let currentBlockIndex = 0;
        let isRandomMode = false; // Mode classique par d√©faut

        // D√©finition de la structure des colonnes
        const verbFields = [
            { key: 'french', display: 'Traduction (Fran√ßais)' },
            { key: 'infinitive', display: 'Infinitif' },
            { key: 'present', display: 'Pr√©sent (er/sie/es)' },
            { key: 'preterite', display: 'Pr√©t√©rit' },
            { key: 'pastParticiple', display: 'Participe Pass√©' }
        ];

        // R√©cup√©ration des √©l√©ments HTML pour l'ajout de verbes
        const inputFrench = document.getElementById('input-french');
        const inputInfinitive = document.getElementById('input-infinitive');
        const inputPresent = document.getElementById('input-present');
        const inputPreterite = document.getElementById('input-preterite');
        const inputPastParticiple = document.getElementById('input-pastParticiple');
        const addButton = document.getElementById('add-button');
        const copyButton = document.getElementById('copy-button');
        const pasteButton = document.getElementById('paste-button');
        const shuffleButton = document.getElementById('shuffle-button');
        const modeToggleButton = document.getElementById('mode-toggle-button');
        const clearButton = document.getElementById('clear-button');

        // R√©cup√©ration des √©l√©ments HTML pour l'exercice
        const exerciceContainer = document.getElementById('exercice-container');
        const tableHeader = document.getElementById('table-header');
        const placeholderText = document.getElementById('placeholder-text');
        const navigationButtons = document.getElementById('navigation-buttons');
        const prevButton = document.getElementById('prev-button');
        const checkButton = document.getElementById('check-button');
        const nextButton = document.getElementById('next-button');
        const resultMessage = document.getElementById('result-message');
        const messageBox = document.getElementById('message-box');
        const confirmModal = document.getElementById('confirm-modal');
        const modalText = document.getElementById('modal-text');
        const confirmOk = document.getElementById('confirm-ok');
        const confirmCancel = document.getElementById('confirm-cancel');
        const blockCounter = document.getElementById('block-counter');
        const copyAreaContainer = document.getElementById('copy-area-container');
        const verbListOutput = document.getElementById('verb-list-output');
        const pasteTarget = document.getElementById('paste-target');

        // Cl√© pour la sauvegarde dans le localStorage
        const localStorageKey = 'germanVerbs';

        // Fonction pour sauvegarder les donn√©es dans le localStorage
        function saveVerbs() {
            try {
                const jsonString = JSON.stringify(verbsData);
                localStorage.setItem(localStorageKey, jsonString);
            } catch (e) {
                console.error("Erreur lors de la sauvegarde dans le localStorage", e);
            }
        }

        // Fonction pour charger les donn√©es depuis le localStorage
        function loadVerbs() {
            try {
                const storedData = localStorage.getItem(localStorageKey);
                if (storedData) {
                    verbsData = JSON.parse(storedData);
                    verbsData.forEach(verb => {
                        verb.correctFields = verb.correctFields || { infinitive: 0, present: 0, preterite: 0, pastParticiple: 0 };
                    });
                }
            } catch (e) {
                console.error("Erreur lors du chargement depuis le localStorage", e);
                verbsData = [];
            }
        }

        // Fonction pour afficher un message temporaire
        function showMessage(msg, type) {
            messageBox.textContent = msg;
            if (type === 'success') {
                messageBox.className = 'message-box show bg-green-200 text-green-800';
            } else if (type === 'error') {
                messageBox.className = 'message-box show bg-red-200 text-red-800';
            }
            setTimeout(() => {
                messageBox.className = 'message-box';
            }, 3000);
        }

        // Fonction pour afficher la bo√Æte de dialogue de confirmation de mani√®re g√©n√©rique
        function showConfirmationModal(message, callback) {
            modalText.innerHTML = message;
            confirmCallback = callback;
            confirmModal.classList.add('show');
        }

        // Fonction pour masquer la bo√Æte de dialogue de confirmation
        function hideConfirmationModal() {
            confirmModal.classList.remove('show');
            confirmCallback = null;
        }

        // Gestionnaires d'√©v√©nements pour la bo√Æte de dialogue
        confirmOk.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback(true);
            }
            hideConfirmationModal();
        });

        confirmCancel.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback(false);
            }
            hideConfirmationModal();
        });

        // Fonction pour ajouter un nouveau verbe √† la liste
        function addVerb() {
            const french = inputFrench.value.trim();
            const infinitive = inputInfinitive.value.trim();
            const present = inputPresent.value.trim();
            const preterite = inputPreterite.value.trim();
            const pastParticiple = inputPastParticiple.value.trim();

            if (!french || !infinitive || !present || !preterite || !pastParticiple) {
                showMessage("Veuillez remplir tous les champs pour ajouter un verbe.", 'error');
                return;
            }

            verbsData.push({
                french: french,
                infinitive: infinitive.toLowerCase(),
                present: present.toLowerCase(),
                preterite: preterite.toLowerCase(),
                pastParticiple: pastParticiple.toLowerCase(),
                correctFields: { infinitive: 0, present: 0, preterite: 0, pastParticiple: 0 }
            });

            saveVerbs();

            inputFrench.value = '';
            inputInfinitive.value = '';
            inputPresent.value = '';
            inputPreterite.value = '';
            inputPastParticiple.value = '';

            showMessage("Verbe ajout√© avec succ√®s !", 'success');
            renderVerbsTable();
        }

        // Fonction pour supprimer un verbe
        function deleteVerb(index) {
            showConfirmationModal("Voulez-vous vraiment supprimer ce verbe ?", (confirmed) => {
                if (confirmed) {
                    verbsData.splice(index, 1);
                    showMessage("Verbe supprim√©.", 'success');
                    saveVerbs();
                    if (verbsData.length === currentBlockIndex * verbsPerBlock && currentBlockIndex > 0) {
                        currentBlockIndex--;
                    }
                    renderVerbsTable();
                }
            });
        }

        // Fonction pour m√©langer le tableau de verbes (lignes)
        function shuffleVerbs() {
            if (verbsData.length <= 1) {
                showMessage("Il faut au moins 2 verbes pour m√©langer la liste.", 'error');
                return;
            }
            
            for (let i = verbsData.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [verbsData[i], verbsData[j]] = [verbsData[j], verbsData[i]];
            }
            
            verbsData.forEach(verb => {
                verb.correctFields = { infinitive: 0, present: 0, preterite: 0, pastParticiple: 0 };
            });
            
            currentBlockIndex = 0;
            saveVerbs();
            renderVerbsTable();
            showMessage("Verbes m√©lang√©s !", 'success');
        }

        // Fonction pour effacer la liste de verbes
        function clearVerbs() {
            showConfirmationModal("Voulez-vous vraiment effacer toute la liste de verbes ? Cette action est irr√©versible.", (confirmed) => {
                if (confirmed) {
                    verbsData = [];
                    localStorage.removeItem(localStorageKey);
                    currentBlockIndex = 0;
                    renderVerbsTable();
                    showMessage("Liste de verbes effac√©e.", 'success');
                }
            });
        }
        
        // Fonction pour copier la liste des verbes dans une zone de texte
        function copyVerbs() {
            const jsonString = JSON.stringify(verbsData);
            verbListOutput.value = jsonString;
            copyAreaContainer.style.display = 'block';
            verbListOutput.select();
            showMessage("S√©lectionnez et copiez le texte ci-dessous pour sauvegarder la liste.", 'success');
        }
        
        // Fonction d√©clench√©e par le bouton "Coller la liste"
        function pasteVerbs() {
            const message = "<b>Le fait d'entrer les verbes manuellement est meilleur pour √©tudier.</b><br>Voulez-vous tout de m√™me coller la liste ? Cette action √©crasera la liste actuelle."
            showConfirmationModal(message, (confirmed) => {
                if (confirmed) {
                    showMessage("Appuyez sur CTRL + V (ou Cmd + V sur Mac) maintenant.", 'success');
                    pasteTarget.focus();
                }
            });
        }
        
        // G√©rer l'√©v√©nement de "coller" r√©el
        function handlePaste(event) {
            const textToPaste = (event.clipboardData || window.clipboardData).getData('text');
            event.preventDefault();

            if (textToPaste === "") {
                showMessage("Rien √† coller.", 'error');
                return;
            }

            performPaste(textToPaste);
        }
        
        // Coller la liste depuis la source (presse-papiers ou zone de texte)
        function performPaste(text) {
            try {
                const newVerbs = JSON.parse(text);
                if (Array.isArray(newVerbs) && newVerbs.every(v => v.french && v.infinitive && v.present && v.preterite && v.pastParticiple)) {
                    verbsData = newVerbs;
                    verbsData.forEach(verb => {
                        verb.correctFields = verb.correctFields || { infinitive: 0, present: 0, preterite: 0, pastParticiple: 0 };
                    });
                    saveVerbs();
                    currentBlockIndex = 0;
                    renderVerbsTable();
                    showMessage("La liste de verbes a √©t√© coll√©e avec succ√®s !", 'success');
                } else {
                    showMessage("Le contenu du presse-papiers n'est pas un format de verbe valide.", 'error');
                }
            } catch (e) {
                showMessage("Erreur lors de la lecture des donn√©es. Assurez-vous d'avoir copi√© une liste valide.", 'error');
            }
        }

        // Fonction pour r√©v√©ler la bonne r√©ponse d'un champ
        function revealAnswer(input) {
            showConfirmationModal("Voulez-vous vraiment r√©v√©ler la r√©ponse ?", (confirmed) => {
                if (confirmed) {
                    const verbIndex = parseInt(input.closest('div[data-verb-index]').dataset.verbIndex);
                    const fieldName = input.dataset.field;
                    const correctValue = verbsData[verbIndex][fieldName];
                    input.value = correctValue;
                    input.classList.remove('incorrect');
                    input.classList.add('correct');
                    verbsData[verbIndex].correctFields[fieldName] = 0;
                    const revealButton = input.nextElementSibling;
                    if (revealButton) {
                        revealButton.remove();
                    }
                }
            });
        }

        // Fonction pour g√©n√©rer l'interface de l'exercice
        function renderVerbsTable() {
            exerciceContainer.innerHTML = '';
            resultMessage.classList.add('hidden');
            copyAreaContainer.style.display = 'none';

            if (verbsData.length === 0) {
                placeholderText.classList.remove('hidden');
                placeholderText.textContent = "Commencez par ajouter un verbe ci-dessus.";
                tableHeader.classList.add('hidden');
                navigationButtons.classList.add('hidden');
                return;
            }

            placeholderText.classList.add('hidden');
            tableHeader.classList.remove('hidden');
            navigationButtons.classList.remove('hidden');

            const totalBlocks = Math.ceil(verbsData.length / verbsPerBlock);
            blockCounter.textContent = `Bloc ${currentBlockIndex + 1} sur ${totalBlocks}`;
            blockCounter.classList.remove('hidden');
            checkButton.classList.remove('hidden');
            nextButton.classList.remove('hidden');

            nextButton.textContent = (currentBlockIndex + 1) >= totalBlocks ? "Voir le score final ‚Üí" : "Suivant ‚Üí";

            const start = currentBlockIndex * verbsPerBlock;
            const end = Math.min(start + verbsPerBlock, verbsData.length);

            const currentBlockVerbs = verbsData.slice(start, end);

            // Cr√©er l'en-t√™te du tableau
            tableHeader.innerHTML = '';
            verbFields.forEach(field => {
                const headerDiv = document.createElement('div');
                headerDiv.className = 'col-span-1';
                headerDiv.textContent = field.display;
                tableHeader.appendChild(headerDiv);
            });
            const actionHeaderDiv = document.createElement('div');
            actionHeaderDiv.className = 'col-span-1';
            actionHeaderDiv.textContent = 'Action';
            tableHeader.appendChild(actionHeaderDiv);


            currentBlockVerbs.forEach((verb, i) => {
                const verbIndex = start + i;
                const row = document.createElement('div');
                row.className = 'grid grid-cols-6 gap-4 items-center';
                row.dataset.verbIndex = verbIndex;

                let displayedColumnKey;
                if (isRandomMode) {
                    // S√©lectionner une colonne al√©atoire √† afficher pour cette ligne
                    const randomFieldIndex = Math.floor(Math.random() * verbFields.length);
                    displayedColumnKey = verbFields[randomFieldIndex].key;
                } else {
                    // Mode classique : toujours afficher la traduction
                    displayedColumnKey = 'french';
                }

                verbFields.forEach(field => {
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'flex items-center space-x-2';
                    
                    if (field.key === displayedColumnKey) {
                        cellDiv.className = 'text-center font-medium text-gray-900';
                        cellDiv.textContent = verb[field.key];
                    } else {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.placeholder = `...`;
                        input.className = 'w-full p-2 border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200';
                        input.dataset.field = field.key;
                        input.dataset.attempts = 0;
                        input.dataset.isRevealed = 'false';

                        if (verbsData[verbIndex].correctFields[field.key] > 0) {
                            input.value = verbsData[verbIndex][field.key];
                            input.classList.add('correct', 'border-green-500');
                            input.disabled = true;
                        }
                        cellDiv.appendChild(input);
                    }
                    row.appendChild(cellDiv);
                });
                
                const deleteButtonDiv = document.createElement('div');
                const deleteButton = document.createElement('button');
                deleteButton.textContent = '‚ùå';
                deleteButton.className = 'bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded-lg transition duration-300 transform hover:scale-110';
                deleteButton.addEventListener('click', () => deleteVerb(verbIndex));
                deleteButtonDiv.appendChild(deleteButton);
                row.appendChild(deleteButtonDiv);

                exerciceContainer.appendChild(row);
            });

            if (currentBlockIndex > 0) {
                prevButton.classList.remove('hidden');
            } else {
                prevButton.classList.add('hidden');
            }
        }

        // Fonction pour v√©rifier toutes les r√©ponses
        function checkAnswers() {
            if (verbsData.length === 0) {
                showMessage("Ajoutez des verbes avant de v√©rifier !", 'error');
                return;
            }
            
            const start = currentBlockIndex * verbsPerBlock;
            const end = Math.min(start + verbsPerBlock, verbsData.length);
            const currentBlockVerbs = verbsData.slice(start, end);
            
            for (let i = 0; i < currentBlockVerbs.length; i++) {
                const verbIndex = start + i;
                const row = document.querySelector(`div[data-verb-index='${verbIndex}']`);
                if (!row) continue;

                const inputDivs = row.querySelectorAll('.flex.items-center');
                
                inputDivs.forEach(inputDiv => {
                    const input = inputDiv.querySelector('input');
                    if (!input) return;
                    
                    const field = input.dataset.field;
                    const userAnswer = input.value.trim().toLowerCase();
                    const correctAnswer = verbsData[verbIndex][field];
                    let attempts = parseInt(input.dataset.attempts);
                    
                    if (verbsData[verbIndex].correctFields[field] > 0 || input.disabled) {
                        return;
                    }

                    const existingRevealButton = inputDiv.querySelector('button');
                    if (existingRevealButton) {
                        existingRevealButton.remove();
                    }

                    input.classList.remove('correct', 'incorrect', 'border-green-500', 'border-red-500');

                    if (userAnswer === correctAnswer) {
                        input.classList.add('correct', 'border-green-500');
                        if (attempts === 0) {
                            verbsData[verbIndex].correctFields[field] = 1;
                        } else {
                            verbsData[verbIndex].correctFields[field] = 0.5;
                        }
                        input.dataset.attempts = 0;
                    } else {
                        input.classList.add('incorrect', 'border-red-500');
                        attempts++;
                        input.dataset.attempts = attempts;
                        
                        if (attempts >= 2) {
                            const revealButton = document.createElement('button');
                            revealButton.textContent = 'üí°';
                            revealButton.className = 'text-xl hover:scale-110 transition-transform';
                            revealButton.onclick = () => revealAnswer(input);
                            inputDiv.appendChild(revealButton);
                        }
                    }
                });
            }

            const totalFieldsForBlock = currentBlockVerbs.length * (verbFields.length - 1);
            const currentBlockScore = currentBlockVerbs.reduce((acc, verb) => {
                const fieldsToScore = Object.keys(verb.correctFields);
                return acc + fieldsToScore.reduce((sum, field) => sum + verb.correctFields[field], 0);
            }, 0);
            
            const scoreForBlock = totalFieldsForBlock > 0 ? Math.round((currentBlockScore / totalFieldsForBlock) * 100) : 0;

            resultMessage.classList.remove('hidden');
            resultMessage.innerHTML = `
                <div class="text-lg font-bold">R√©sultat du bloc :</div>
                <div class="text-xl mt-2">Score : ${currentBlockScore} sur ${totalFieldsForBlock}</div>
                <div class="text-2xl font-bold mt-2">Score en pourcentage : ${scoreForBlock}%</div>
            `;
            // Corrected the classList.add to handle multiple classes
            const classesToAdd = (scoreForBlock >= 70 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800').split(' ');
            resultMessage.classList.add(...classesToAdd);
        }

        // Fonction pour g√©rer le bouton de navigation "Suivant"
        function handleNext() {
            const totalBlocks = Math.ceil(verbsData.length / verbsPerBlock);
            if (currentBlockIndex + 1 >= totalBlocks) {
                displayFinalScreen();
            } else {
                currentBlockIndex++;
                renderVerbsTable();
            }
        }

        // Fonction pour passer au bloc pr√©c√©dent
        function prevBlock() {
            if (currentBlockIndex > 0) {
                currentBlockIndex--;
                renderVerbsTable();
                resultMessage.classList.add('hidden');
            }
        }

        // Fonction pour afficher l'√©cran de fin
        function displayFinalScreen() {
            const totalFields = verbsData.length * (verbFields.length - 1);
            const finalScore = verbsData.reduce((acc, verb) => {
                const fieldsToScore = Object.keys(verb.correctFields);
                return acc + fieldsToScore.reduce((sum, field) => sum + verb.correctFields[field], 0);
            }, 0);

            const finalPercentage = totalFields > 0 ? Math.round((finalScore / totalFields) * 100) : 0;
            
            exerciceContainer.innerHTML = '';
            tableHeader.classList.add('hidden');
            blockCounter.classList.add('hidden');
            resultMessage.classList.remove('hidden');
            prevButton.classList.add('hidden');
            nextButton.classList.add('hidden');
            checkButton.classList.add('hidden');

            resultMessage.innerHTML = `
                <div class="text-6xl mb-4">üèÜ</div>
                <div class="text-3xl font-bold">F√©licitations !</div>
                <div class="text-2xl mt-4">Vous avez termin√© tous les exercices.</div>
                <div class="text-xl mt-4">Votre score total est de :</div>
                <div class="text-5xl font-extrabold mt-2">${finalPercentage}%</div>
                <div class="text-lg mt-2">${finalScore} sur ${totalFields} points possibles</div>
            `;
            // Corrected the classList.add to handle multiple classes
            const classesToAdd = (finalPercentage >= 70 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800').split(' ');
            resultMessage.classList.add(...classesToAdd);
        }

        // Fonction pour basculer le mode d'affichage
        function toggleDisplayMode() {
            isRandomMode = !isRandomMode;
            modeToggleButton.textContent = isRandomMode ? 'Mode Classique' : 'Mode Al√©atoire';
            renderVerbsTable();
        }

        // √âv√©nements
        addButton.addEventListener('click', addVerb);
        copyButton.addEventListener('click', copyVerbs);
        pasteButton.addEventListener('click', pasteVerbs);
        shuffleButton.addEventListener('click', shuffleVerbs);
        modeToggleButton.addEventListener('click', toggleDisplayMode);
        clearButton.addEventListener('click', clearVerbs);
        pasteTarget.addEventListener('paste', handlePaste);
        checkButton.addEventListener('click', checkAnswers);
        nextButton.addEventListener('click', handleNext);
        prevButton.addEventListener('click', prevBlock);

        // Permettre l'ajout d'un verbe en appuyant sur 'Entr√©e' dans le dernier champ
        inputPastParticiple.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                addVerb();
            }
        });

        // Initialisation de l'application
        window.onload = function() {
            loadVerbs();
            renderVerbsTable();
        };
    </script>
</body>
</html>
